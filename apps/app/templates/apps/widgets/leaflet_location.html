{% load static %}

<style>
    #map {
        height: 400px; /* must have a height! */
        margin-top: 1em;
        border: 1px solid #ccc;
    }
</style>

<div id="map"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      const latInput = document.getElementById("id_{{ lat_field }}");
  const lonInput = document.getElementById("id_{{ lon_field }}");

  // fallback starting position
  let lat = parseFloat(latInput?.value) || 40.0;
  let lon = parseFloat(lonInput?.value) || -3.7;

  // initialize map
  const map = L.map("map").setView([lat, lon], 6);

  // add OpenStreetMap tiles
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  // add draggable marker
  let marker = L.marker([lat, lon], { draggable: true }).addTo(map);

  // update inputs when marker moves
  function updateInputs(e) {
    const { lat, lng } = e.latlng || marker.getLatLng();
    if (latInput) latInput.value = lat.toFixed(6);
    if (lonInput) lonInput.value = lng.toFixed(6);
  }

  marker.on("dragend", updateInputs);

  // update marker when clicking on map
  map.on("click", function (e) {
    marker.setLatLng(e.latlng);
    updateInputs(e);
  });
});
</script>
